<!DOCTYPE html>
<html lang="pt" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Estatísticas do Sistema</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 10px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); }
        h1 { color: #333; margin-bottom: 30px; text-align: center; }
        h2 { color: #667eea; margin-top: 25px; margin-bottom: 15px; font-size: 1.3em; }
        .stats-card { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #667eea; }
        ul { list-style: none; margin: 15px 0; }
        li { padding: 10px; margin: 5px 0; background: white; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        button { background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 1em; margin-top: 20px; width: 100%; }
        button:hover { background: #5568d3; }
        #status-bar { background-color: #ffc107; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>
<div class="container">
    <h1>Estatísticas do Sistema</h1>
    <div id="status-bar">Aguardando Conexão...</div>

    <div id="server-data" style="display:none;">
        <div th:if="${stats != null}">
            <span th:each="entry : ${stats.top10Searches}"
                  class="data-top10"
                  th:data-key="${entry.key}"
                  th:data-val="${entry.value}"></span>

            <span th:each="entry : ${stats.barrelMetrics}"
                  class="data-barrel"
                  th:data-name="${entry.key}"
                  th:data-size="${entry.value.indexSize}"
                  th:data-time="${entry.value.avgResponseTimeMs}"></span>
        </div>
    </div>

    <div class="stats-card">
        <h2>Top 10 Pesquisas:</h2>
        <ul id="top-searches-list"><li>(A carregar...)</li></ul>
    </div>

    <div class="stats-card">
        <h2>Tamanho e Tempos de Resposta:</h2>
        <ul id="barrel-metrics-list"><li>(A carregar...)</li></ul>
    </div>

    <form th:action="@{/menu}" method="GET"><button>Voltar ao Menu</button></form>
</div>

<script>
    let stompClient = null;

    // 2. LER DADOS DO HTML ESCONDIDO (Executa instantaneamente)
    function loadInitialDataFromDOM() {
        let initialStats = { top10Searches: [], barrelMetrics: {} };
        let hasData = false;

        // Ler Top 10 do HTML
        document.querySelectorAll('.data-top10').forEach(el => {
            initialStats.top10Searches.push({
                key: el.dataset.key,
                value: parseInt(el.dataset.val)
            });
            hasData = true;
        });

        // Ler Barrels do HTML
        document.querySelectorAll('.data-barrel').forEach(el => {
            initialStats.barrelMetrics[el.dataset.name] = {
                indexSize: parseInt(el.dataset.size),
                avgResponseTimeMs: parseInt(el.dataset.time)
            };
            hasData = true;
        });

        if (hasData) {
            updateStatsUI(initialStats);
            document.getElementById('status-bar').innerText = 'Dados Carregados (Conectando...)';
            document.getElementById('status-bar').style.backgroundColor = '#17a2b8';
        }
    }

    function connect() {
        let socket = new SockJS('/my-websocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
            document.getElementById('status-bar').innerText = 'CONECTADO (Tempo Real)';
            document.getElementById('status-bar').style.backgroundColor = '#28a745';
            stompClient.subscribe('/topic/stats', function (msg) {
                updateStatsUI(JSON.parse(msg.body));
            });
        }, function(err) {
            console.error(err);
        });
    }

    function updateStatsUI(stats) {
        // --- TOP 10 ---
        let topList = document.getElementById('top-searches-list');
        topList.innerHTML = '';
        let list = [];

        // Normaliza a lista (Array, Objeto ou Mapa)
        if (stats && stats.top10Searches) {
            if (Array.isArray(stats.top10Searches)) list = stats.top10Searches;
            else if (typeof stats.top10Searches === 'object') {
                Object.entries(stats.top10Searches).forEach(([k,v]) => list.push({key:k, value:v}));
            }
        }

        let hasItems = false;
        list.forEach(entry => {
            let k = entry.key || entry.term || '';
            let v = entry.value || entry.count || 0;

            // Tratamento especial para mapas dinâmicos {"termo": 10}
            if (!k && typeof entry === 'object') {
                let keys = Object.keys(entry); if(keys.length>0) { k=keys[0]; v=entry[k]; }
            }
            // Tratamento especial para string "termo=10"
            if (!k && typeof entry === 'string' && entry.includes('=')) {
                let p = entry.split('='); k=p[0].trim(); v=parseInt(p[1])||0;
            }

            if(k && k.trim() !== '') {
                hasItems = true;
                topList.innerHTML += `<li><span>${k}</span><strong>${v} vezes</strong></li>`;
            }
        });
        if (!hasItems) topList.innerHTML = '<li>Nenhuma pesquisa registrada.</li>';

        // --- BARRELS ---
        let barrelList = document.getElementById('barrel-metrics-list');
        barrelList.innerHTML = '';
        let hasBarrels = false;
        let totalTime = 0; let count = 0;

        if (stats && stats.barrelMetrics) {
            for (const [name, m] of Object.entries(stats.barrelMetrics)) {
                hasBarrels = true; count++;
                let t = m.avgResponseTimeMs || 0;
                totalTime += t;
                barrelList.innerHTML += `<li><span>Barrel: <strong>${name}</strong></span><span>Índice: <strong>${m.indexSize||0}</strong></span><span style="color:${t>500?'red':'green'}">Tempo: <strong>${t} ms</strong></span></li>`;
            }
        }
        if(!hasBarrels) barrelList.innerHTML = '<li>Nenhum Barrel ativo.</li>';
        else barrelList.innerHTML += `<li style="background:#e6e6e6;margin-top:10px"><span>MÉDIA GERAL:</span><strong>${(totalTime/count).toFixed(0)} ms</strong></li>`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadInitialDataFromDOM(); // 1. Carrega dados instantaneamente
        connect();                // 2. Liga WebSocket
    });
</script>
</body>
</html>